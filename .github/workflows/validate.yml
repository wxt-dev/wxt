name: âœ… Validate

on:
  workflow_call:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  checks:
    name: Checks
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm check

  builds:
    name: Builds
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm buildc all

  build-demo:
    name: Build Demo
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm build:all
        working-directory: packages/wxt-demo
      - run: pnpm wxt zip
        working-directory: packages/wxt-demo

  tests:
    name: Tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - uses: oven-sh/setup-bun@v2
      - name: pnpm test:coverage
        run: pnpm test:coverage -- --reporter=default --reporter=hanging-process
      - uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  windows-tests:
    name: Windows Tests
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup
      - run: pnpm test

  template:
    name: Template
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        template:
          - react
          - solid
          - svelte
          - vanilla
          - vue

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - run: pnpm pack
        working-directory: packages/wxt

      - run: npm i
        working-directory: templates/${{ matrix.template }}

      - run: npm i -D ../../packages/wxt/wxt-*.tgz
        working-directory: templates/${{ matrix.template }}

      - run: pnpm compile
        if: matrix.template != 'svelte'
        working-directory: templates/${{ matrix.template }}

      - run: pnpm check
        if: matrix.template == 'svelte'
        working-directory: templates/${{ matrix.template }}

      - run: pnpm build
        working-directory: templates/${{ matrix.template }}
